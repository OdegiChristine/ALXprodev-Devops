#!/bin/bash

POKEMON="pikachu"
API_URL="https://pokeapi.co/api/v2/pokemon/$POKEMON"
OUTPUT_FILE="data.json"
ERROR_FILE="errors.txt"

# Clear old error log
> "$ERROR_FILE"

# Retry logic
ATTEMPT=1
SUCCESS=false

while [ $ATTEMPT -le 3 ]; do
    STATUS_CODE=$(curl -s -o "$OUTPUT_FILE" -w "%{http_code}" "$API_URL")

    if [ "$STATUS_CODE" -eq 200 ]; then
        SUCCESS=true
        break
    else
        echo "Attempt $ATTEMPT failed for $POKEMON (status: $STATUS_CODE). Retrying..."
        sleep 2
    fi

    ATTEMPT=$((ATTEMPT + 1))
done

if [ "$SUCCESS" = false ]; then
    echo "Error: Failed to retrieve data for $POKEMON after 3 attempts" >> "$ERROR_FILE"
    exit 1
fi

# Extract data from JSON
NAME=$(jq -r '.name' "$OUTPUT_FILE")
HEIGHT=$(jq -r '.height' "$OUTPUT_FILE")
WEIGHT=$(jq -r '.weight' "$OUTPUT_FILE")
TYPE=$(jq -r '.types[0].type.name' "$OUTPUT_FILE")

# Convert units
HEIGHT_M=$(awk "BEGIN {printf \"%.1f\", $HEIGHT / 10}")
WEIGHT_KG=$(awk "BEGIN {printf \"%.1f\", $WEIGHT / 10}")

# Capitalize first letter of name and type
NAME_CAP=$(echo "$NAME" | sed 's/.*/\u&/')
TYPE_CAP=$(echo "$TYPE" | sed 's/.*/\u&/')

# Final output
echo "$NAME_CAP is of type $TYPE_CAP, weighs ${WEIGHT_KG}kg, and is ${HEIGHT_M}m tall."
